version: "3.9"

x-pyrrha-build: &pyrrha-build
  context: .
  dockerfile: Dockerfile

x-pyrrha-node: &pyrrha-node
  image: pyrrha:local
  restart: unless-stopped
  stop_grace_period: 30s
  networks:
    - pyrrha

services:
  pyrrha-seed:
    <<: *pyrrha-node
    build: *pyrrha-build
    container_name: pyrrha-seed
    volumes:
      - ./data/node-seed:/home/pyrrha/.pyrrha
    ports:
      - target: 21090
        published: ${PYRRHA_SEED_P2P_PORT:-0}
        protocol: tcp
      - target: 21091
        published: ${PYRRHA_SEED_RPC_PORT:-0}
        protocol: tcp
      - target: 21092
        published: ${PYRRHA_SEED_ZMQ_PORT:-0}
        protocol: tcp
    command: ["seed-entrypoint.sh"]
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -d '{\"jsonrpc\":\"2.0\",\"id\":\"0\",\"method\":\"get_info\"}' -H 'Content-Type: application/json' http://localhost:21091/json_rpc | grep -q '\"status\":\"OK\"'"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 30s

  pyrrha-peer-1:
    <<: *pyrrha-node
    container_name: pyrrha-peer-1
    volumes:
      - ./data/node-1:/home/pyrrha/.pyrrha
    ports:
      - target: 30090
        published: ${PYRRHA_PEER1_P2P_PORT:-0}
        protocol: tcp
      - target: 30091
        published: ${PYRRHA_PEER1_RPC_PORT:-0}
        protocol: tcp
      - target: 30092
        published: ${PYRRHA_PEER1_ZMQ_PORT:-0}
        protocol: tcp
    command:
      - pyrrhad
      - --data-dir=/home/pyrrha/.pyrrha
      - --p2p-bind-ip=0.0.0.0
      - --p2p-bind-port=30090
      - --rpc-bind-ip=0.0.0.0
      - --rpc-bind-port=30091
      - --zmq-rpc-bind-ip=0.0.0.0
      - --zmq-rpc-bind-port=30092
      - --confirm-external-bind
      - --non-interactive
      - --prune-blockchain
      - --fixed-difficulty=1
      - --enable-dns-blocklist=0
      - --add-priority-node=pyrrha-seed:21090
      - --add-priority-node=pyrrha-peer-2:40090
      - --add-priority-node=pyrrha-peer-3:50090
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -d '{\"jsonrpc\":\"2.0\",\"id\":\"0\",\"method\":\"get_info\"}' -H 'Content-Type: application/json' http://localhost:30091/json_rpc | grep -q '\"status\":\"OK\"'"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 30s

  pyrrha-peer-2:
    <<: *pyrrha-node
    container_name: pyrrha-peer-2
    volumes:
      - ./data/node-2:/home/pyrrha/.pyrrha
    ports:
      - target: 40090
        published: ${PYRRHA_PEER2_P2P_PORT:-0}
        protocol: tcp
      - target: 40091
        published: ${PYRRHA_PEER2_RPC_PORT:-0}
        protocol: tcp
      - target: 40092
        published: ${PYRRHA_PEER2_ZMQ_PORT:-0}
        protocol: tcp
    command:
      - pyrrhad
      - --data-dir=/home/pyrrha/.pyrrha
      - --p2p-bind-ip=0.0.0.0
      - --p2p-bind-port=40090
      - --rpc-bind-ip=0.0.0.0
      - --rpc-bind-port=40091
      - --zmq-rpc-bind-ip=0.0.0.0
      - --zmq-rpc-bind-port=40092
      - --confirm-external-bind
      - --non-interactive
      - --prune-blockchain
      - --fixed-difficulty=1
      - --enable-dns-blocklist=0
      - --add-priority-node=pyrrha-seed:21090
      - --add-priority-node=pyrrha-peer-1:30090
      - --add-priority-node=pyrrha-peer-3:50090
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -d '{\"jsonrpc\":\"2.0\",\"id\":\"0\",\"method\":\"get_info\"}' -H 'Content-Type: application/json' http://localhost:40091/json_rpc | grep -q '\"status\":\"OK\"'"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 30s

  pyrrha-peer-3:
    <<: *pyrrha-node
    container_name: pyrrha-peer-3
    volumes:
      - ./data/node-3:/home/pyrrha/.pyrrha
    ports:
      - target: 50090
        published: ${PYRRHA_PEER3_P2P_PORT:-0}
        protocol: tcp
      - target: 50091
        published: ${PYRRHA_PEER3_RPC_PORT:-0}
        protocol: tcp
      - target: 50092
        published: ${PYRRHA_PEER3_ZMQ_PORT:-0}
        protocol: tcp
    command:
      - pyrrhad
      - --data-dir=/home/pyrrha/.pyrrha
      - --p2p-bind-ip=0.0.0.0
      - --p2p-bind-port=50090
      - --rpc-bind-ip=0.0.0.0
      - --rpc-bind-port=50091
      - --zmq-rpc-bind-ip=0.0.0.0
      - --zmq-rpc-bind-port=50092
      - --confirm-external-bind
      - --non-interactive
      - --prune-blockchain
      - --fixed-difficulty=1
      - --enable-dns-blocklist=0
      - --add-priority-node=pyrrha-seed:21090
      - --add-priority-node=pyrrha-peer-1:30090
      - --add-priority-node=pyrrha-peer-2:40090
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -d '{\"jsonrpc\":\"2.0\",\"id\":\"0\",\"method\":\"get_info\"}' -H 'Content-Type: application/json' http://localhost:50091/json_rpc | grep -q '\"status\":\"OK\"'"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 30s

networks:
  pyrrha:
    driver: bridge
